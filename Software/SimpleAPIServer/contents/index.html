<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="stylesheet" href="bootstrap.min.css">
  <!-- load jQuery -->
  <script src="jquery-3.6.0.min.js"></script>
  <!-- load bootstrap.js -->
  <script src="bootstrap.bundle.min.js"></script>
  <!-- load bs-custom-file-input plugin -->
  <script src="bs-custom-file-input.js"></script>
  <title>Edge Detection</title>
  <style>
    .container{
      margin: 30px;
    }
    .flex{
      display: flex;
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>エッジ抽出APIデモ</h1>
    <div class="flex">
      <canvas id="canvas-l" width="512" height="384"></canvas>
      <canvas id="canvas-r" width="512" height="384"></canvas>
    </div>
    <form>
      <br>
      <div class="form-group">
        <label for="input_file">File input</label>
        <div class="input-group">
          <div class="custom-file">
            <input type="file" class="custom-file-input" id="input_file" accept=".bmp, .jpg, .jpeg" required>
            <label class="custom-file-label" for="input_file" data-browse="参照">Select File (or Drag & Drop)</label>
          </div>
          <div class="input-group-append">
            <button type="button" class="btn btn-outline-secondary input-group-text" id="input_file_reset">取消</button>
          </div>
        </div>
      </div>
      <hr />
      <input type="button" class="btn btn-primary" id="upload_file" value="Apply Filter">
    </form>
  </div>
  <!-- my js -->
  <script>
    window.addEventListener('DOMContentLoaded', function () {

      document.getElementById("input_file").addEventListener("change", loadImg, false);
      function loadImg(e) {
        // load file
        const file = this.files[0];
        const reader = new FileReader();
        reader.onload = () => {
          // create empty image instance
          const image = new Image();
          image.src = reader.result;
          // display image
          const canvas = document.getElementById('canvas-l');
          const ctx = canvas.getContext('2d');
          image.onload = () => {
            ctx.drawImage(image, 0, 0, 512, 384);
          }
        };
        // read image as base64
        reader.readAsDataURL(file)
      }

      document.getElementById("upload_file").addEventListener('click', retrieveEdgeDetectedImage, false);
      function retrieveEdgeDetectedImage(e) {
        const canvas = document.getElementById('canvas-l');
        let data = {
          // remove "data:image/png;base64," from the beginning of the string
          "base64_image": canvas.toDataURL('image/png').replace(/data:.*;base64,/, '')
        };
        // make API call
        fetch('/post', {
          method: 'post',
          header: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        })
          .then(response => response.json())  // when response arrives
          .then(data => {
            // create empty image instance
            const image = new Image();
            image.src = "data:image/bmp;base64," + data.base64_edge_detected_image;
            // display image
            const canvas = document.getElementById('canvas-r');
            const ctx = canvas.getContext('2d');
            image.onload = () => {
              ctx.drawImage(image, 0, 0, 512, 384);
            }
          });
      }
    });

    // bootstrap settings
    bsCustomFileInput.init();

    document.getElementById('input_file_reset').addEventListener('click', function () {
      bsCustomFileInput.destroy();

      var elem = document.getElementById("input_file");
      elem.value = '';
      var clone = elem.cloneNode(false);
      elem.parentNode.replaceChild(clone, elem);

      bsCustomFileInput.init();
    });
  </script>
</body>

</html>